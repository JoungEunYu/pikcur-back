<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pikcurchu.pikcur.mapper.SearchMapper">
    <select id="selectSearchGoodsList" resultType="com.pikcurchu.pikcur.dto.response.ResGoodsBidListDto">
        SELECT
        g.goods_id,
        g.category_id,
        g.brand_id,
        g.goods_name,
        g.buyout_price,
        g.start_price,
        g.auction_end_date,
        g.create_date,
        COALESCE(b.bidCount, 0) AS bidCount,
        CASE
        WHEN #{memberNo} IS NULL THEN FALSE
        WHEN glMember.goods_like_id IS NOT NULL THEN TRUE
        ELSE FALSE
        END AS isLiked,
        sm.status_name
        FROM goods g
        join brand b ON g.brand_id = b.brand_id
        LEFT JOIN (
        SELECT goods_id, COUNT(*) AS bidCount
        FROM bid
        GROUP BY goods_id
        ) b ON g.goods_id = b.goods_id
        LEFT JOIN (
        SELECT goods_id, goods_like_id
        FROM goods_like
        WHERE member_no = #{memberNo}
        ) glMember ON g.goods_id = glMember.goods_id
        LEFT JOIN Status_master sm
        ON g.status_type = sm.status_type
        AND g.status_no = sm.status_no
        where g.goods_name LIKE "%#{keyword}%" OR b.brand_name LIKE "%#{keyword}%"
        ORDER BY g.goods_id DESC;
    </select>
    <select id="selectSearchHistory" resultType="com.pikcurchu.pikcur.dto.response.ResSearchDto">
        select keyword
        from search_history
        where member_no = #{memberNo}
        order by create_date desc;
    </select>
    <select id="selectSearchTop10" resultType="com.pikcurchu.pikcur.dto.response.ResSearchDto">
        SELECT keyword
        FROM Search_history
        GROUP BY keyword
        ORDER BY COUNT(*) DESC
        LIMIT 10;
    </select>

</mapper>